---
title: "Flammulated Owl Fall Prospecting Analysis"
author: "Scott Yanco"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    code_folding: "hide"
    css: style.css  
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy = TRUE)
```


#Required Libraries

```{r message=FALSE, warning=FALSE}
#data mgmt
library(tidyverse) 

#plotting
library(ggplot2)
library(ggmosaic)
library(wesanderson)
library(png)
library(grid)

#inference
library(lme4)
library(AICcmodavg)
```

# Initial Data Import, Cleaning, and Management 

Load in the data.

```{r}
#read in data, excerpt NA rows at bottom of morph_data
deut_data <- read.csv("Deut.csv", stringsAsFactors = F) #iso data
morph_data <- read.csv("Morph.csv", stringsAsFactors = F) #capture data
morph_data <- morph_data[1:216,] #clean the capture data
```

Lots of data cleaning and formatting...

```{r}
#add status column to delineate known local birds and fall unknown-origin
deut_data$status <- ifelse(deut_data$Date == "#N/A", "local", "fall") 

#change date format
deut_data$Date[deut_data$Date == "#N/A"] <- NA
deut_data$Julian[deut_data$Julian == "#N/A"] <- NA
deut_data$Julian <- as.numeric(deut_data$Julian)
deut_data$Date <- as.Date(deut_data$Date, format = "%d/%m/%Y")
morph_data$Date[morph_data$Date == "#N/A"] <- NA
morph_data$Julian[morph_data$Julian == "#N/A"] <- NA
morph_data$Date <- as.Date(morph_data$Date, format = "%d/%m/%Y")
morph_data$PAge[morph_data$PAge == "2"] <- "A"
morph_data$PAge[morph_data$PAge == "3"] <- "A"

#convert to factors
deut_data$status <- as.factor(deut_data$status)
```

# Compare double measured birds 

This section analyzes birds for which we have two feather isotope values for different feather types.  This helps us validate the use of juvenile  contour feathers in analyses that otherwise include adult remiges.

```{r}
#extract all the double measured individuals
#keep only duplicated bands
doubles <- deut_data[duplicated(deut_data$Band) | duplicated(deut_data$Band, 
                                                             fromLast = T),] 
#sort by band number and then feather type
doubles <- doubles[order(doubles$Band, doubles$FeatherType),] 

#remove single case with 2 primaries and no juv
doubles <- filter(doubles, doubles$Band != "1833-03340") 

#convert to factors
doubles$Band <- as.factor(doubles$Band)

```

Now we take the difference in $\delta D$ values between paired measurements from single individuals.

```{r}
difs <- c()
for (i in 1:length(unique(doubles$Band))) {
  difs[i] <- doubles$dD[doubles$Band == unique(doubles$Band)[i] 
                        & doubles$FeatherType == "j"] - doubles$dD[doubles$Band == unique(doubles$Band)[i] & 
                                                                     doubles$FeatherType == "p"]
}

difs <- data.frame(dD = difs)

```

We now make a plot showing the distribution of differences.

```{r}
difs_plot <- ggplot(data = difs, aes(x = 1, y = dD)) +
  geom_boxplot(width = .2) +
  geom_jitter(position = position_jitter(0.05)) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  xlim(c(0.5, 1.5)) +
  ylim(c(-25, 25)) +
  ylab(expression(paste("Difference in ", delta, "D", sep = ""))) +
  theme_classic() +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), 
        axis.title.x = element_blank())

difs_plot
```

Inferential test (if we must...), both a paired t-test and an information theoretic approach.

```{r}
#one sample t-test on the pairwise difs (paired t-test)
t.test(x = difs) 

fit.dif.int <- lmer(dD ~ 1 + (1|Band), data = doubles, REML = F)
fit.dif.type <- lmer(dD ~ FeatherType + (1|Band), data = doubles, REML = F)

aictab(list("intercept" = fit.dif.int, "dD by type" =fit.dif.type))
```

We can clearly see that the t-test showed a high probability of the null hypothesis (no mean pairwise differences between feather types) producing results as or more unusual than ours.  Similarly, the information theoretic approach showed that the most competitive model was intercept only (akin the the null model) and had 78% of the model weighting.  Thee inferences are consistent with our figure and we conclude that the feather type is inconsequential for juvenile birds.

# Isotope analyis for known- and unknown-origin birds

```{r}
#create color palette
pal <- c("#3B9AB2", "#EBCC2A")

#plot histograms with rug plot
deut_hist <- ggplot(data = deut_data) +
  geom_density(aes(x = dD, fill = status, color = status), alpha = .35) + 
  scale_fill_manual(values = pal) +
  geom_rug(aes(x = dD, color = status)) +
  scale_color_manual(values = pal) +
  xlab(expression(paste(delta, "D", sep = ""))) +
  scale_y_continuous(breaks=seq(0,.06,.05)) +
  theme_classic()
deut_hist
```

Again, a couple ways of looking at this inferentially.  First we can do a Kolmogorovâ€“Smirnov  to get a p-value about these being drawn from the same population distribution.  We can also do a two-sample t test to look for differences in means.  Finally, we can again fit a couple linear models and use information theory. Also, so summary stats here.

```{r}
#inferential tests
ks.test(x=deut_data$dD[deut_data$status == "fall"], 
        y=deut_data$dD[deut_data$status == "local"])

t.test(x=deut_data$dD[deut_data$status == "fall"], 
        y=deut_data$dD[deut_data$status == "local"])

fit.int <- lm(dD ~ 1, data = deut_data)
fit.status <- lm(dD ~ status, data = deut_data)
aictab(list("intercept" = fit.int, "dD by status" = fit.status))
summary(fit.int)
summary(fit.status)
```

Also, so summary stats here.

```{r}
summary(deut_data$dD[deut_data$status == "fall"])
sd(deut_data$dD[deut_data$status == "fall"])

summary(deut_data$dD[deut_data$status == "local"])
sd(deut_data$dD[deut_data$status == "local"])
```
# Fall to Breeding Individuals

Now let's look at our fall birds recaptured as breeders in subsequent years relative to the dD distributions.

```{r}
falltosummer <- c("1783-64429","1833-03191","1783-64490","1783-64452",
                  "1833-03104","1833-03116","1833-03309","1833-03322",
                  "1833-03307","1783-74351","1833-03329","1833-03417")
recap_deut <- deut_data$dD[which(deut_data$Band %in% falltosummer)]
recap_bands <- deut_data$Band[which(deut_data$Band %in% falltosummer)]
deut_local <- deut_data[deut_data$status == "local",]
owl <- readPNG("FLOW Line Drawing.png")
g1 <- rasterGrob(owl, interpolate=FALSE)

deut_cap <- ggplot(data = deut_data) +
  geom_density(aes(x = dD, fill = status, color = status), alpha = .35) + 
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_vline(xintercept = recap_deut, color = "#3B9AB2", linetype = "dashed") +
  geom_text(aes(x=recap_deut[1]-2, y = .016, label = paste0(recap_bands[1]), 
                angle = 90)) +
  geom_text(aes(x=recap_deut[2]-2, y = .016, label = paste0(recap_bands[2]), 
                angle = 90)) +
  annotation_custom(g1, xmin=recap_deut[1]-10, xmax = recap_deut[1],
                    ymin = 0, ymax = .01) +
  annotation_custom(g1, xmin=recap_deut[2]-10, xmax = recap_deut[2], 
                    ymin = 0, ymax = .01) +
  xlab(expression(paste(delta, "D", sep = ""))) +
  scale_y_continuous(breaks=seq(0,.06,.05)) +
  theme_classic()
deut_cap
ggsave("owlplot.png", dpi = 400)
```

# dD by Time
We can also ask whether we see evidence of migration picking up late by considering whether dD varies by date. We'll first graph it.

```{r}
#dD by julian date
deut_by_date <- ggplot(data = na.omit(deut_data), aes(x = Julian, y = dD)) +
  geom_point() +
  geom_smooth(method = "lm", color = "black") +
  ylab(expression(paste(delta, "D", sep = ""))) +
  xlab("Julian Date") +
  scale_y_continuous(breaks=c(-85,-65,-45)) +
  scale_x_continuous(breaks=c(244,249,255)) +
  theme_classic()

deut_by_date
```

We can also run the linear model for this.

```{r}
deut_time <- deut_data[!is.na(deut_data$Julian),] #clean out missing data

fit.notime <- lm(dD ~ 1, data = deut_time)
fit.time <- lm(dD ~ Julian, data = deut_time)

aictab(list("intercept" = fit.notime, "dD by time" = fit.time))
summary(fit.time)
summary(fit.notime)
```

Basically two equally plausible models - interesting that the time covariate model is the best but when we look at the $\beta_1$ estimate it's basically 0 with very high SE, so no real evidence that time explains mean variation in $\delta D$.

# Passage Rates


```{r}
#need to get net hours by date to normalize this
caps <- c()
dates <- c()
for(i in 1:unique(morph_data$Julian)) {
  caps[[i]] <- sum(morph_data$Julian == unique(morph_data$Julian)[i])
  dates[[i]] <- unique(morph_data$Julian)[i] 
}

caprates <- data.frame("date" = dates, "captures" = caps)

cap_rate_plot <- ggplot(data = caprates, aes(x=date, y = captures)) +
  geom_point(color = "black") +
  stat_smooth(aes(y = captures),method = "lm", formula = y ~ x + I(x^2),
              color = "black") +
    theme_classic()

cap_rate_plot


# #violin plot of capture by date
# sexknown <- morph_data[morph_data$Final.Sex != "U",]
# sexknown <- sexknown[sexknown$PAge == "A",]
# sexknown$sexyear <- paste0(sexknown$Final.Sex, sexknown$Year)
# caps_by_sex_date <- ggplot(data = sexknown, aes(x = sexyear, y = Julian, 
#                                                 fill = Final.Sex) +
#   geom_violin(alpha = .3) +
#   geom_boxplot(width = 0.2))
```

